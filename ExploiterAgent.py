import json
import os
import pathlib
from dotenv import load_dotenv

from langchain_core.runnables import Runnable
from langchain_core.output_parsers import StrOutputParser
from langchain_groq import ChatGroq

# --- IMPORT CENTRALIZED PROMPT ---
from prompts import RED_TEAM_PROMPT

load_dotenv()

def get_groq_model() -> ChatGroq:
    # This model is for TEXT generation (Markdown), so we do NOT use json_object mode
    return ChatGroq(
        model_name="llama-3.3-70b-versatile",
        temperature=0.1
    )

def run_exploiter_agent(logic_report_path: str, source_code_path: str, output_dir: str, model: Runnable):
    print(f"\n[Phase 5] Running Exploiter Agent (Red Team Documentation)...")

    try:
        with open(logic_report_path, 'r', encoding='utf-8') as f:
            logic_data = json.load(f)
        source_code = pathlib.Path(source_code_path).read_text(encoding='utf-8')
    except Exception as e:
        print(f"⚠️ Skipping Exploiter: Could not read inputs ({e})")
        return

    # Find Critical Logic bugs
    vulnerabilities = logic_data.get("logic_vulnerabilities", [])
    # Filter for High or Critical issues only
    critical_vulns = [
        v for v in vulnerabilities 
        if "Critical" in v.get("true_impact", "") or "High" in v.get("true_impact", "")
    ]

    if not critical_vulns:
        print("   -> No CRITICAL/HIGH logic vulnerabilities found. No exploits needed.")
        return

    # Setup Chain with imported prompt
    chain = RED_TEAM_PROMPT | model | StrOutputParser()

    os.makedirs(output_dir, exist_ok=True)
    print(f"   -> Found {len(critical_vulns)} Major Vulnerabilities. Generating Attack Manuals...")

    for i, vuln in enumerate(critical_vulns, 1):
        try:
            vuln_title = vuln.get('title', 'Unknown_Vuln')
            print(f"   -> Analyzing Vector: {vuln_title}...")

            manual_content = chain.invoke({
                "title": vuln_title,
                "explanation": vuln.get("explanation"),
                "source_code": source_code
            })

            # Clean filename
            safe_title = vuln_title.replace(" ", "_").replace("/", "-").replace("\\", "-")
            filename = f"RedTeam_Manual_{i}_{safe_title}.md"
            file_path = os.path.join(output_dir, filename)

            with open(file_path, "w", encoding="utf-8") as f:
                f.write(manual_content)

            print(f"      ✅ Generated Manual: {file_path}")

        except Exception as e:
            print(f"      ❌ Failed to generate manual for {vuln.get('title')}: {e}")